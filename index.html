<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gluten Free Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #212121;
            --tg-theme-text-color: #ffffff;
            --tg-theme-button-color: #3390ec;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-hint-color: #aaaaaa;
            --card-bg: #2f2f2f;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #212121);
            color: var(--tg-theme-text-color, #ffffff);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px; /* место для кнопки */
        }

        h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        /* Сетка товаров */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background-color: #3f3f3f;
        }

        .card-content {
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .card-desc {
            font-size: 11px;
            color: var(--tg-theme-hint-color, #aaaaaa);
            margin-bottom: 8px;
            flex-grow: 1;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .price {
            font-weight: 700;
            font-size: 15px;
        }

        .add-btn {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .add-btn:active {
            opacity: 0.8;
        }

        /* Контрол количества */
        .counter {
            display: none;
            align-items: center;
            background: #3f3f3f;
            border-radius: 6px;
            padding: 2px;
        }

        .counter.active {
            display: flex;
        }

        .counter-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            user-select: none;
        }

        .counter-val {
            width: 24px;
            text-align: center;
            font-size: 14px;
        }

        /* Главная кнопка внизу */
        .main-button-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px;
            background: var(--tg-theme-bg-color, #212121);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: none; /* скрыта пока нет заказов */
        }
        
        .main-button {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
        }

        /* Лоадер */
        .loader {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Меню</h1>
    <div id="loader" class="loader">Загрузка вкусняшек...</div>
    <div id="grid" class="grid"></div>
</div>

<div id="bottomBar" class="main-button-container">
    <button id="orderBtn" class="main-button" onclick="checkout()">
        Оформить заказ
    </button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); // На весь экран

    // --- НАСТРОЙКИ ---
    // СЮДА ВСТАВИТЬ СВОЙ URL ВЕБХУКА N8N
    const API_URL = 'https://n8n.apexstack.ru/webhook/products'; 
    // -----------------

    let products = [];
    let cart = {}; // id -> count

    async function loadProducts() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            
            // Если n8n вернул массив напрямую или внутри объекта
            products = Array.isArray(data) ? data : (data.data || []);
            
            renderProducts();
            document.getElementById('loader').style.display = 'none';
        } catch (e) {
            document.getElementById('loader').innerText = 'Ошибка загрузки меню :(';
            console.error(e);
        }
    }

    function renderProducts() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';

        products.forEach(p => {
            // Если картинки нет, ставим заглушку
            const img = p.image_url && p.image_url.length > 5 ? p.image_url : 'https://via.placeholder.com/300x200?text=No+Photo';

            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `
                <img src="${img}" class="card-image" alt="${p.title}">
                <div class="card-content">
                    <div class="card-title">${p.title}</div>
                    <div class="card-desc">${p.description || ''}</div>
                    <div class="card-footer">
                        <div class="price">${p.price} ₽</div>
                        
                        <button class="add-btn" id="btn-add-${p.id}" onclick="addToCart(${p.id})">
                            Добавить
                        </button>
                        
                        <div class="counter" id="counter-${p.id}">
                            <div class="counter-btn" onclick="updateCart(${p.id}, -1)">−</div>
                            <div class="counter-val" id="val-${p.id}">1</div>
                            <div class="counter-btn" onclick="updateCart(${p.id}, 1)">+</div>
                        </div>
                    </div>
                </div>
            `;
            grid.appendChild(el);
        });
    }

    function addToCart(id) {
        updateCart(id, 1);
    }

    function updateCart(id, change) {
        if (!cart[id]) cart[id] = 0;
        cart[id] += change;

        if (cart[id] <= 0) {
            delete cart[id];
            // Показываем кнопку "Добавить", скрываем счетчик
            document.getElementById(`btn-add-${id}`).style.display = 'block';
            document.getElementById(`counter-${id}`).classList.remove('active');
        } else {
            // Скрываем кнопку, показываем счетчик
            document.getElementById(`btn-add-${id}`).style.display = 'none';
            const counter = document.getElementById(`counter-${id}`);
            counter.classList.add('active');
            document.getElementById(`val-${id}`).innerText = cart[id];
        }

        updateMainButton();
    }

    function updateMainButton() {
        const totalItems = Object.values(cart).reduce((a, b) => a + b, 0);
        const bottomBar = document.getElementById('bottomBar');
        const orderBtn = document.getElementById('orderBtn');

        if (totalItems > 0) {
            // Считаем сумму
            let totalSum = 0;
            for (const [id, count] of Object.entries(cart)) {
                const prod = products.find(p => p.id == id);
                if (prod) totalSum += prod.price * count;
            }

            bottomBar.style.display = 'block';
            orderBtn.innerText = `Оформить на ${totalSum} ₽`;
            tg.MainButton.show(); // Можно использовать нативную кнопку
        } else {
            bottomBar.style.display = 'none';
            tg.MainButton.hide();
        }
    }

    function checkout() {
        // Готовим данные для отправки боту
        const orderData = {
            cart: [],
            total: 0
        };

        for (const [id, count] of Object.entries(cart)) {
            const prod = products.find(p => p.id == id);
            if (prod) {
                orderData.cart.push({
                    id: prod.id,
                    title: prod.title,
                    count: count,
                    price: prod.price,
                    sum: prod.price * count
                });
                orderData.total += prod.price * count;
            }
        }

        // Отправляем данные обратно в Telegram
        tg.sendData(JSON.stringify(orderData));
    }

    // Запуск
    loadProducts();

</script>
</body>
</html>